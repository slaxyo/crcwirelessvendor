<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clarkston Vendor Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #dbeafe, #f0f9ff);
      color: #111827;
    }
    .login, .container {
      max-width: 960px;
      margin: auto;
      padding: 40px 20px;
    }
    .login {
      text-align: center;
      margin-top: 120px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    }
    input[type="password"] {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      width: 240px;
      font-size: 1rem;
    }
    button {
      padding: 12px 18px;
      background-color: #3b82f6;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #2563eb;
    }
    h1 {
      text-align: center;
      color: #1e3a8a;
      font-size: 2rem;
      margin-bottom: 16px;
    }
    .logo {
      width: 130px;
      display: block;
      margin: 0 auto 20px;
    }
    .summary {
      text-align: center;
      font-weight: 500;
      margin-bottom: 20px;
    }
    .table-wrapper {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      background-color: #f1f5f9;
      color: #374151;
      font-size: 0.95rem;
    }
    td {
      font-size: 0.92rem;
    }
    .note-toggle {
      color: #2563eb;
      cursor: pointer;
      font-weight: 500;
    }
    .hidden-note {
      display: none;
      background: #f9fafb;
      padding: 10px;
      border-left: 3px solid #3b82f6;
      margin-top: 4px;
      border-radius: 8px;
      color: #374151;
    }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
    }
    .checked-in {
      background-color: #10b981 !important;
    }
  </style>
</head>
<body>
  <div class="login" id="login">
    <h2>Enter Password to Access Dashboard</h2>
    <input type="password" id="password" placeholder="Enter password" />
    <button onclick="checkPassword()">Access</button>
  </div>

  <div class="container" id="dashboard" style="display:none">
    <img class="logo" src="IMG_0018 (1).png" alt="CRCWireless Logo">
    <h1>Vendor Submissions</h1>
    <div class="summary" id="vendorStats"></div>
    <div class="table-wrapper">
      <table id="vendorTable">
        <thead>
          <tr><th>Vendors</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Edit Vendor</h3>
      <input type="text" id="editName" placeholder="Business Name" />
      <input type="text" id="editContact" placeholder="Contact Name" />
      <input type="text" id="editPhone" placeholder="Phone" />
      <input type="email" id="editEmail" placeholder="Email" />
      <textarea id="editNotes" rows="3" placeholder="Notes"></textarea>
      <button onclick="saveEdit()">Save Changes</button>
      <button onclick="closeEditModal()">Cancel</button>
    </div>
  </div>

  <script>
    const PASSWORD = "market2024";
    const COOKIE_KEY = "auth";
    const COOKIE_VALUE = PASSWORD;

    const SUPABASE_URL = "https://stgcknunpvlcndtwxdmc.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN0Z2NrbnVucHZsY25kdHd4ZG1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwNTM2MTUsImV4cCI6MjA2NDYyOTYxNX0.H2JawYsroeA5Tnc_iIeGhRX0kLcUIk0bP3F7rK0JyX4";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const login = document.getElementById("login");
    const dashboard = document.getElementById("dashboard");
    const vendorStats = document.getElementById("vendorStats");

    window.onload = function () {
      const isAuthed = document.cookie
        .split("; ")
        .find((row) => row.startsWith(`${COOKIE_KEY}=`));
      if (isAuthed) {
        login.style.display = "none";
        dashboard.style.display = "block";
        loadVendors();
      }
    };

    function setAuthCookie() {
      document.cookie = `${COOKIE_KEY}=${COOKIE_VALUE}; path=/; max-age=86400`;
    }

    function checkPassword() {
      const input = document.getElementById("password").value;
      if (input === PASSWORD) {
        setAuthCookie();
        login.style.display = "none";
        dashboard.style.display = "block";
        loadVendors();
      } else {
        alert("Incorrect password.");
      }
    }

    async function loadVendors() {
      const { data, error } = await supabaseClient.from("vendors").select("*");
      if (error) return console.error("Load error:", error);

      const tbody = document.querySelector("#vendorTable tbody");
      tbody.innerHTML = "";

      let total = 0;
      let checkedIn = 0;

      data.forEach((v) => {
        total++;
        if (v.checkedIn) checkedIn++;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td colspan="11">
            <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 8px; align-items: flex-start;">
              <div style="flex: 1;">
                <strong>${v.vendorName}</strong> â€” ${v.vendorType}<br>
                <small>Contact:</small> ${v.contactName} <br>  Phone: ${v.phone} <br> Email: ${v.email}<br>
                <small>Setup:</small> ${v.setupTime} <br> Power: ${v.power} <br> Table: ${v.table}<br>
                <small>Description:</small> ${v.description}<br>
                ${v.social ? `<small>Social:</small> ${v.social}<br>` : ""}
                <span class="note-toggle" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block'">Toggle Notes</span>
                <div class="hidden-note">${v.notes || ""}</div>
              </div>
              <div style="min-width: 140px; text-align: right;">
                <button onclick="toggleCheckIn(${v.id}, ${v.checkedIn})" ${v.checkedIn ? 'class="checked-in"' : ''}>${v.checkedIn ? "Checked In" : "Check In"}</button><br>
                <button onclick="editVendor(${v.id}, \`${v.vendorName}\`, \`${v.contactName}\`, \`${v.phone}\`, \`${v.email}\`, \`${v.notes || ""}\`)" style="margin-top: 6px;">Edit</button>
                <button onclick="deleteVendor(${v.id})">Delete</button>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });

      vendorStats.textContent = `Total Vendors: ${total} | Checked In: ${checkedIn} | Not Checked In: ${total - checkedIn}`;
    }

    async function toggleCheckIn(id, currentStatus) {
      const { error } = await supabaseClient.from("vendors").update({ checkedIn: !currentStatus }).eq("id", id);
      if (error) return alert("Failed to update check-in status");
      loadVendors();
    }

    async function deleteVendor(id) {
      if (!confirm("Are you sure you want to delete this vendor?")) return;
      const { error } = await supabaseClient.from("vendors").delete().eq("id", id);
      if (error) return alert("Failed to delete.");
      loadVendors();
    }

    function editVendor(id, name, contact, phone, email, notes) {
      currentEditId = id;
      document.getElementById("editName").value = name;
      document.getElementById("editContact").value = contact;
      document.getElementById("editPhone").value = phone;
      document.getElementById("editEmail").value = email;
      document.getElementById("editNotes").value = notes;
      document.getElementById("editModal").style.display = "flex";
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
    }

    async function saveEdit() {
      const updatedData = {
        vendorName: document.getElementById("editName").value,
        contactName: document.getElementById("editContact").value,
        phone: document.getElementById("editPhone").value,
        email: document.getElementById("editEmail").value,
        notes: document.getElementById("editNotes").value
      };
      const { error } = await supabaseClient.from("vendors").update(updatedData).eq("id", currentEditId);
      if (error) return alert("Update failed");
      closeEditModal();
      loadVendors();
    }
  </script>
</body>
</html>